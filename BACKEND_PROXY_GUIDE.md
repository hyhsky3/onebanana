# ğŸ” åç«¯ä»£ç†è¯´æ˜æ–‡æ¡£

æœ¬é¡¹ç›®ä½¿ç”¨ **Cloudflare Pages Functions** ä½œä¸ºåç«¯ä»£ç†ï¼Œä¿æŠ¤ API Key ä¸æš´éœ²ç»™å‰ç«¯ç”¨æˆ·ã€‚

---

## ğŸ“‹ ä¸ºä»€ä¹ˆéœ€è¦åç«¯ä»£ç†ï¼Ÿ

### é—®é¢˜ï¼šå‰ç«¯ç¯å¢ƒå˜é‡ä¸å®‰å…¨

åœ¨ Vite é¡¹ç›®ä¸­ï¼Œæ‰€æœ‰ä»¥ `VITE_` å¼€å¤´çš„ç¯å¢ƒå˜é‡éƒ½ä¼šè¢«**æ‰“åŒ…è¿›å‰ç«¯ JavaScript ä»£ç **ã€‚

```javascript
// æ„å»ºåçš„ä»£ç ä¸­ä¼šç›´æ¥åŒ…å«ï¼š
const API_KEY = "sk-xxxx...";  // âš ï¸ ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°ï¼
```

ç”¨æˆ·åªéœ€è¦ï¼š
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åœ¨ Sources ä¸­æœç´¢ `sk-`
3. å³å¯è·å–æ‚¨çš„ API Key

### è§£å†³æ–¹æ¡ˆï¼šåç«¯ä»£ç†

```
ä¹‹å‰ï¼ˆä¸å®‰å…¨ï¼‰ï¼š
  æµè§ˆå™¨ â†’ ç›´æ¥è°ƒç”¨ AI API (æš´éœ² Key)

ç°åœ¨ï¼ˆå®‰å…¨ï¼‰ï¼š
  æµè§ˆå™¨ â†’ /api/generate (æ‚¨çš„åç«¯) â†’ AI API
                  â†‘
            API Key åœ¨è¿™é‡Œï¼ˆç”¨æˆ·çœ‹ä¸åˆ°ï¼‰
```

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### æ–‡ä»¶ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ functions/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ generate.js      # åç«¯ä»£ç†ï¼ˆCloudflare Functionsï¼‰
â”œâ”€â”€ src/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ laozhangApi.js   # å‰ç«¯ API æœåŠ¡
â”œâ”€â”€ .env.local               # æœ¬åœ°å¼€å‘ç¯å¢ƒå˜é‡
â”œâ”€â”€ .dev.vars                # Cloudflare æœ¬åœ°å¼€å‘å˜é‡
â””â”€â”€ .env.example             # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

### è¯·æ±‚æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/generate     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ä»£ç    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚  Cloudflare      â”‚
â”‚             â”‚     { prompt, images }     â”‚  Functions       â”‚
â”‚ laozhangApi â”‚                            â”‚  generate.js     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â”‚ POST /v1beta/models/...:generateContent
                                                    â”‚ Authorization: Bearer ${AI_API_KEY}
                                                    â–¼
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚   AI API         â”‚
                                           â”‚   api.n1n.ai     â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®

### å˜é‡ç±»å‹è¯´æ˜

| å‰ç¼€ | å¯è§æ€§ | ç”¨é€” |
|------|--------|------|
| `VITE_` | âš ï¸ å‰ç«¯å¯è§ | åªæ”¾ä¸æ•æ„Ÿçš„é…ç½®ï¼ˆå¦‚è®¿é—®å¯†ç ï¼‰ |
| æ— å‰ç¼€ | âœ… åç«¯ä¸“ç”¨ | æ”¾ API Key ç­‰æ•æ„Ÿä¿¡æ¯ |

### ç”Ÿäº§ç¯å¢ƒé…ç½® (Cloudflare Pages)

åœ¨ **Settings â†’ Environment variables** ä¸­é…ç½®ï¼š

| å˜é‡å | ç¤ºä¾‹å€¼ | å¿…å¡« | è¯´æ˜ |
|--------|--------|------|------|
| `AI_API_KEY` | `sk-xxxx...` | âœ… | AI API å¯†é’¥ï¼ˆåç«¯ä¸“ç”¨ï¼‰ |
| `AI_BASE_URL` | `https://api.n1n.ai/v1beta` | âŒ | API åŸºç¡€åœ°å€ï¼ˆæœ‰é»˜è®¤å€¼ï¼‰ |
| `AI_MODEL_ID` | `gemini-3-pro-image-preview` | âŒ | æ¨¡å‹ IDï¼ˆæœ‰é»˜è®¤å€¼ï¼‰ |
| `VITE_ACCESS_PASSWORD` | `0760` | âŒ | å‰ç«¯è®¿é—®å¯†ç  |

### æœ¬åœ°å¼€å‘é…ç½®

**`.env.local`** - å‰ç«¯å˜é‡ï¼ˆå¼€å‘ç¯å¢ƒç›´è¿ AI APIï¼‰ï¼š
```env
VITE_AI_API_KEY=sk-xxxx...
VITE_AI_BASE_URL=https://api.n1n.ai/v1beta
VITE_AI_MODEL_ID=gemini-3-pro-image-preview
VITE_ACCESS_PASSWORD=0760
```

**`.dev.vars`** - åç«¯å˜é‡ï¼ˆwrangler æœ¬åœ°å¼€å‘ï¼‰ï¼š
```env
AI_API_KEY=sk-xxxx...
AI_BASE_URL=https://api.n1n.ai/v1beta
AI_MODEL_ID=gemini-3-pro-image-preview
```

---

## ğŸ”Œ API æ¥å£è¯´æ˜

### åç«¯ä»£ç†æ¥å£

**ç«¯ç‚¹**: `POST /api/generate`

**è¯·æ±‚ä½“**:
```json
{
  "prompt": "ä¸€åªå¯çˆ±çš„çŒ«å’ªåœ¨è‰åœ°ä¸Šç©è€",
  "images": ["data:image/jpeg;base64,..."],  // å¯é€‰ï¼Œå›¾ç”Ÿå›¾æ—¶ä½¿ç”¨
  "aspectRatio": "1:1",                       // å¯é€‰ï¼Œé»˜è®¤ 1:1
  "resolution": "1k"                          // å¯é€‰ï¼Œ1k/2k/4k
}
```

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "imageBase64": "iVBORw0KGgoAAAANS...",
  "mimeType": "image/png",
  "textContent": ""
}
```

**å¤±è´¥å“åº”**:
```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯"
}
```

---

## ğŸ§ª æœ¬åœ°å¼€å‘

### æ–¹å¼ 1ï¼šå‰ç«¯ç›´è¿ï¼ˆç®€å•ï¼‰

ç›´æ¥è¿è¡Œ `npm run dev`ï¼Œå‰ç«¯ä¼šä½¿ç”¨ `.env.local` ä¸­çš„ `VITE_AI_API_KEY` ç›´æ¥è°ƒç”¨ AI APIã€‚

```bash
npm run dev
# æµè§ˆå™¨è®¿é—® http://localhost:5173
```

### æ–¹å¼ 2ï¼šå®Œæ•´æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒï¼‰

ä½¿ç”¨ Wrangler æ¨¡æ‹Ÿ Cloudflare Functionsï¼š

```bash
# å®‰è£… wrangler
npm install -g wrangler

# å¯åŠ¨å®Œæ•´ç¯å¢ƒ
npx wrangler pages dev dist --port 8788
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. æ¨é€ä»£ç åˆ° GitHub

```bash
git add -A
git commit -m "æ›´æ–°ä»£ç "
git push origin main
```

### 2. é…ç½® Cloudflare Pages

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. è¿›å…¥ **Workers & Pages** â†’ é€‰æ‹©æ‚¨çš„é¡¹ç›®
3. **Settings** â†’ **Environment variables**
4. æ·»åŠ  `AI_API_KEY` å’Œå…¶ä»–å¿…è¦å˜é‡
5. ç‚¹å‡» **Save**

### 3. è§¦å‘é‡æ–°éƒ¨ç½²

é…ç½®ç¯å¢ƒå˜é‡åï¼Œéœ€è¦é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆï¼š
- æ¨é€æ–°æäº¤ï¼Œæˆ–
- åœ¨ **Deployments** é¡µé¢ç‚¹å‡» **Retry deployment**

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

1. **æ°¸è¿œä¸è¦**åœ¨ GitHub ä»“åº“ä¸­æäº¤ `.env.local` æˆ– `.dev.vars`
2. **æ°¸è¿œä¸è¦**ä½¿ç”¨ `VITE_` å‰ç¼€é…ç½® API Key
3. å®šæœŸè½®æ¢ API Key
4. åœ¨ Cloudflare åå°è®¾ç½®ä½¿ç”¨é™åˆ¶å’Œå‘Šè­¦

---

## â“ å¸¸è§é—®é¢˜

### Q: æœ¬åœ°å¼€å‘æ—¶ API è°ƒç”¨å¤±è´¥ï¼Ÿ

æ£€æŸ¥ `.env.local` ä¸­æ˜¯å¦æ­£ç¡®é…ç½®äº† `VITE_AI_API_KEY`ã€‚

### Q: éƒ¨ç½²å API è°ƒç”¨å¤±è´¥ï¼Ÿ

æ£€æŸ¥ Cloudflare Pages ç¯å¢ƒå˜é‡ä¸­æ˜¯å¦é…ç½®äº† `AI_API_KEY`ï¼ˆä¸å¸¦ VITE_ å‰ç¼€ï¼‰ã€‚

### Q: å¦‚ä½•éªŒè¯ API Key æ˜¯å¦å®‰å…¨ï¼Ÿ

1. éƒ¨ç½²åæ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åœ¨ Sources ä¸­æœç´¢ `sk-`
3. å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯´æ˜é…ç½®æ­£ç¡®

---

*æ–‡æ¡£æ›´æ–°æ—¶é—´: 2026-01-28*
